image: node:12
pipelines:
  branches:
    develop:
      - step:
          caches:
            - node
          name: 'Develop service release'
          deployment: test
          script:
            - npm install
            - npm run build
            - npm run release
            - VERSION=$(npm run version --silent)
            - git tag -am "Release $VERSION" $VERSION
            - if [[ $(git rev-parse --is-shallow-repository) == false ]]; then git fetch --unshallow || echo 'Fail to fetch unshallow'; fi
            - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
            - git fetch origin
            - git checkout --track origin/release/dev
            - git merge develop
            - git push origin release/dev
    release/dev:
      - step:
          caches:
            - node
          name: 'Deploy in alfa'
          deployment: test
          script:
            - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
            - git fetch origin
            - git checkout --track origin/release/alfa
            - git merge develop
            - git push --follow-tags origin release/alfa
    
  pull-requests:
    '**':
      - step:
          caches:
            - node
          name: 'Pull request check'
          script:
            - npm install
            - npm run build
